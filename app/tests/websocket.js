const WS = require("nativescript-websockets");

ws_vector = [
    {
        path: "ws://gasser.blue:7003/PoPServer/GetInstanceID",
        send: "0a20b73b5efd15eb6bd808da4ae7ecd0c696f505172dddfa045aa063c8f92506df05",
        rcv: "0a20fd804b7cee247844b5ec298db07098b50cb5cadb55d2e3c65e917a22c7c78358"
    },
    {
        path: "ws://gasser.blue:7003/OmniLedger/GetProof",
        send: "0802122000000000000000000000000000000000000000000000000000000000000000001a200d75236a47c8b61b27b47da1df6af68e793ae68fa895eed95c6e5310846d5eab",
        rcv: "080212d31f0abb160a20000000000000000000000000000000000000000000000000000000000000000012700a001200120012001a440a202ad0437b5d447d02f59c651ede8e75f98a735b0efd3e1be4cff7f096f367494012205c69f681b046ec25477b496a4fedb87d2097294aa167e85399eeb9e5a6ee0f7f222016f6dc28108a9ae05c66afa4fe58ce1d86b01bdf500bf4f867dc782167fe5ed11ae4010a700a001200120012001a440a205d109482622e7543f3306a6aaa9489ea6f5dc82df2888fead7301d023cad5e05122010d9a7f0c4c0d8aa7f936b767fee08d1097b363e4972e058f2961fb836f8ca5222202ad0437b5d447d02f59c651ede8e75f98a735b0efd3e1be4cff7f096f367494012700a001200120012001a440a20725a5ce814c0a3129374d05687b004819870e43003fdcf6f1d1f69c467ee3d2612203ad25030c2c4bc8ccb973bc3a4183a84e368f7b35625401559180e3f017a4e7322205c69f681b046ec25477b496a4fedb87d2097294aa167e85399eeb9e5a6ee0f7f1ae4010a700a001200120012001a440a20668ab4e8aefeced834aa5a6e3a3eb6f0c7518157ff3f13446dfa59ab2ddd622b1220c95f69cac709dba1d88aba75934de3a3ffda0ff56e2f928c84ef35d637affb6a22205d109482622e7543f3306a6aaa9489ea6f5dc82df2888fead7301d023cad5e05127"
    },
    {
        path: "ws://gasser.blue:7003/OmniLedger/GetProof",
        send: "0802122011910580e99f594ff1a415611f36ba4af04441c1a0d2d380cff1ffb95c67270e1a200d75236a47c8b61b27b47da1df6af68e793ae68fa895eed95c6e5310846d5eab",
        rcv: "080212f81b0ae0120a2011910580e99f594ff1a415611f36ba4af04441c1a0d2d380cff1ffb95c67270e12700a001200120012001a440a202ad0437b5d447d02f59c651ede8e75f98a735b0efd3e1be4cff7f096f367494012205c69f681b046ec25477b496a4fedb87d2097294aa167e85399eeb9e5a6ee0f7f222016f6dc28108a9ae05c66afa4fe58ce1d86b01bdf500bf4f867dc782167fe5ed11ae4010a700a001200120012001a440a205d109482622e7543f3306a6aaa9489ea6f5dc82df2888fead7301d023cad5e05122010d9a7f0c4c0d8aa7f936b767fee08d1097b363e4972e058f2961fb836f8ca5222202ad0437b5d447d02f59c651ede8e75f98a735b0efd3e1be4cff7f096f367494012700a001200120012001a440a20725a5ce814c0a3129374d05687b004819870e43003fdcf6f1d1f69c467ee3d2612203ad25030c2c4bc8ccb973bc3a4183a84e368f7b35625401559180e3f017a4e7322205c69f681b046ec25477b496a4fedb87d2097294aa167e85399eeb9e5a6ee0f7f1ae4010a700a001200120012001a440a20cb81e34b08f128b4a95f14cb9068356817253be61b8d578124fcc833ac2deacd1220ddaafe82b559b424e09a8e31e79d4c6e92feb772b0a85a6ca899da7130c2cfe32220725a5ce814c0a3129374d05687b004819870e43003fdcf6f1d1f69c467ee3d26127"
    },
    {
        path: "ws://gasser.blue:7005/Skipchain/GetSingleBlock",
        send: "0a200d75236a47c8b61b27b47da1df6af68e793ae68fa895eed95c6e5310846d5eab",
        rcv: "08001014181420142a205958fd0ededa30b551b29a8f0e110f86c9301022382a690548c975ae3b2d9ca83210a7f6cdb747f856b4aff5ece35a8824893210c6247de8bb655fdb8a4231e8452eee163a0042004a700a20cf2ddb5cb6a271f57348d54444bddbdc02f9c5fc2ec5a8233c28c0d625b87e9a12206ee4b1dfb3ba72a32e9a568a1d832f263b856c04ec9f51892c31bc773fc6426e1a20738bb3de544398009afbe9af92a38c660cc1f923151b6539b8282142b13932e9208c85a0a8c1bcb9d22a52a4020a102e4b58c7e45556a59b8d962001010e9e124e0a200c3b6a49d8fce7a258739d041f514cada655bbc07d308df87a4263dfd29c937212104fa379a56ae15aa782cf558e890464651a16746c733a2f2f6761737365722e626c75653a373030322200124e0a2057febd70afe2af12892b338837d59de6ba5bed00e47d9ad84396a20d5b463e971210986435a3aeb356f9bbd280902635af231a16746c733a2f2f6761737365722e626c75653a373030342200124e0a20f742dc9d10296a3d2c1c506d0cae4387e1ae2020d9de246dcfacf4273766337b1210782dfff7dd62541488cc9d251d3917231a16746c733a2f2f6761737365722e626c75653a3730303622001a206f6cdbe6085fa91003fc3fb0aaf0758fffb587d8ee2b1a1cbba1bb6a1d41b5505a200d75236a47c8b61b27b47da1d"
    },
    {
        path: "ws://gasser.blue:7003/Skipchain/GetUpdateChain",
        send: "0a200d75236a47c8b61b27b47da1df6af68e793ae68fa895eed95c6e5310846d5eab",
        rcv: "0a871008001014181420142a205958fd0ededa30b551b29a8f0e110f86c9301022382a690548c975ae3b2d9ca83210a7f6cdb747f856b4aff5ece35a8824893210c6247de8bb655fdb8a4231e8452eee163a0042004a700a20cf2ddb5cb6a271f57348d54444bddbdc02f9c5fc2ec5a8233c28c0d625b87e9a12206ee4b1dfb3ba72a32e9a568a1d832f263b856c04ec9f51892c31bc773fc6426e1a20738bb3de544398009afbe9af92a38c660cc1f923151b6539b8282142b13932e9208c85a0a8c1bcb9d22a52a4020a102e4b58c7e45556a59b8d962001010e9e124e0a200c3b6a49d8fce7a258739d041f514cada655bbc07d308df87a4263dfd29c937212104fa379a56ae15aa782cf558e890464651a16746c733a2f2f6761737365722e626c75653a373030322200124e0a2057febd70afe2af12892b338837d59de6ba5bed00e47d9ad84396a20d5b463e971210986435a3aeb356f9bbd280902635af231a16746c733a2f2f6761737365722e626c75653a373030342200124e0a20f742dc9d10296a3d2c1c506d0cae4387e1ae2020d9de246dcfacf4273766337b1210782dfff7dd62541488cc9d251d3917231a16746c733a2f2f6761737365722e626c75653a3730303622001a206f6cdbe6085fa91003fc3fb0aaf0758fffb587d8ee2b1a1cbba1bb6a1d41b5505a200d75236a47c8b61b27b"
    },
    {
        path: "ws://gasser.blue:7003/OmniLedger/GetProof",
        send: "08021220fd804b7cee247844b5ec298db07098b50cb5cadb55d2e3c65e917a22c7c783581a200d75236a47c8b61b27b47da1df6af68e793ae68fa895eed95c6e5310846d5eab",
        rcv: "080212e71d0acf140a20fd804b7cee247844b5ec298db07098b50cb5cadb55d2e3c65e917a22c7c7835812700a001200120012001a440a202ad0437b5d447d02f59c651ede8e75f98a735b0efd3e1be4cff7f096f367494012205c69f681b046ec25477b496a4fedb87d2097294aa167e85399eeb9e5a6ee0f7f222016f6dc28108a9ae05c66afa4fe58ce1d86b01bdf500bf4f867dc782167fe5ed11ae4010a700a001200120012001a440a205d109482622e7543f3306a6aaa9489ea6f5dc82df2888fead7301d023cad5e05122010d9a7f0c4c0d8aa7f936b767fee08d1097b363e4972e058f2961fb836f8ca5222202ad0437b5d447d02f59c651ede8e75f98a735b0efd3e1be4cff7f096f367494012700a001200120012001a440a20725a5ce814c0a3129374d05687b004819870e43003fdcf6f1d1f69c467ee3d2612203ad25030c2c4bc8ccb973bc3a4183a84e368f7b35625401559180e3f017a4e7322205c69f681b046ec25477b496a4fedb87d2097294aa167e85399eeb9e5a6ee0f7f1ae4010a700a001200120012001a440a20cb81e34b08f128b4a95f14cb9068356817253be61b8d578124fcc833ac2deacd1220ddaafe82b559b424e09a8e31e79d4c6e92feb772b0a85a6ca899da7130c2cfe32220725a5ce814c0a3129374d05687b004819870e43003fdcf6f1d1f69c467ee3d26127"
    }
]

function uint82hex(uint8){
    return Buffer.from(uint8).toString('hex')
}

/**
 * @param msg {{path, send, rcv}}
 * @returns {Promise<any>}
 */
function verifyComm(msg) {
    return new Promise((resolve, reject) => {
        console.log("connecting to: " + msg.path);
        const ws = new WS(msg.path);

        ws.on('open', () => {
            console.log("sending data:", msg.send);
            ws.send(msg.send);
        });

        ws.on('message', (socket, message) => {
            let buf = new Uint8Array(message);

            console.log("receiving data: " + Buffer.from(buf).toString('hex'));
            if (buf == Buffer.from(msg.rcv, 'hex')){
                console.log("data is correct");
                resolve();
            } else {
                console.log("wrong data, should be: " + msg.rcv)
            }
            ws.close();
        });

        ws.on('close', (socket, code, reason) => {
            console.log("closing:", code, reason);
        });

        ws.on('error', (socket, error) => {
            console.log("error is:", error);
            reject(error);
        });

        ws.open();
    })
}

// A sample Jasmine test
describe("Getting a pop-party proof", function () {
    it("should pass all these tests...", function () {
        var queue = Promise.resolve();
        vector.forEach(msg => {
            queue = queue.then(() => {
                return verifyComm(msg);
            })
        })
        expect(true).toBe(true);
    });
});
